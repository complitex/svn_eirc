<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ru.flexpay.eirc.service_provider_account.service.FinancialAttributeBean">

    <resultMap id="FinancialAttribute" type="ru.flexpay.eirc.service_provider_account.entity.FinancialAttribute">
        <id     column="id"                             property="id"/>
        <result column="amount"                         property="amount"/>
        <result column="date_formation"                 property="dateFormation"/>
        <association property="serviceProviderAccount"  resultMap="ru.flexpay.eirc.service_provider_account.service.ServiceProviderAccountBean.ServiceProviderAccount"/>
    </resultMap>

    <cache/>

    <sql id="tableName">`template`</sql>

    <sql id="financialAttributeColumns">
        fa.`id` as `fa_id`, fa.`amount` as `fa_amount`,
        <choose>
            <when test="last == 'true'">
                max(fa.`date_formation`)
            </when>
            <otherwise>
                fa.`date_formation`
            </otherwise>
        </choose>
        as `fa_date_formation`
    </sql>

    <sql id="financialAttributeLastColumns">
        fa.`id` as `fa_id`, fa.`amount` as `fa_amount`, max(fa.`date_formation`) as `fa_date_formation`
    </sql>

    <sql id="financialAttributeWhere">
        <where>
            <if test="object != null">
                <if test="object.id != null">
                    and fa.`id` = #{id}
                </if>
                <include refid="ru.flexpay.eirc.service_provider_account.service.ServiceProviderAccountBean.generalWithAddressSPACondition"/>
            </if>
        </where>
    </sql>


    <sql id="selectFinancialAttributes">
        select
        <include refid="ru.flexpay.eirc.service_provider_account.service.FinancialAttributeBean.financialAttributeColumns"/>,
        <include refid="ru.flexpay.eirc.service_provider_account.service.ServiceProviderAccountBean.generalWithAddressSPAColumns"/>
        from

        <include refid="tableName"/> as fa

        left join `service_provider_account` spa on spa.`id` = fa.`service_provider_account_id`
        <include refid="ru.flexpay.eirc.service_provider_account.service.ServiceProviderAccountBean.generalWithAddressSPAJoin"/>

        <include refid="ru.flexpay.eirc.service_provider_account.service.FinancialAttributeBean.financialAttributeWhere"/>

        <if test="sortProperty != null">
            order by ${sortProperty}

            <if test="asc">
                ${asc}
            </if>
        </if>
        <if test="count > 0">
            limit ${first},${count}
        </if>
    </sql>

    <sql id="selectAllPeriodDateFinancialAttributes">
        <bind name="last" value="false"/>
        <include refid="ru.flexpay.eirc.service_provider_account.service.FinancialAttributeBean.selectFinancialAttributes"/>
    </sql>

    <sql id="selectLastDateFinancialAttributes">
        <bind name="last" value="true"/>
        <include refid="ru.flexpay.eirc.service_provider_account.service.FinancialAttributeBean.selectFinancialAttributes"/>
    </sql>


    <sql id="countFinancialAttributes">
        select count(distinct `id`) from
        <include refid="tableName"/> as fa

        left join `service_provider_account` spa on spa.`id` = fa.`service_provider_account_id`
        <include refid="ru.flexpay.eirc.service_provider_account.service.ServiceProviderAccountBean.generalWithAddressSPAJoin"/>

        <include refid="ru.flexpay.eirc.service_provider_account.service.FinancialAttributeBean.financialAttributeWhere"/>

    </sql>

    <sql id="countAllPeriodDateFinancialAttributes">
        <bind name="last" value="false"/>
        <include refid="ru.flexpay.eirc.service_provider_account.service.FinancialAttributeBean.countFinancialAttributes"/>
    </sql>

    <sql id="countLastDateFinancialAttributes">
        <bind name="last" value="true"/>
        <include refid="ru.flexpay.eirc.service_provider_account.service.FinancialAttributeBean.countFinancialAttributes"/>
    </sql>


    <sql id="selectFinancialAttribute">
        <bind name="last" value="false"/>
        select
        <include refid="ru.flexpay.eirc.service_provider_account.service.FinancialAttributeBean.financialAttributeColumns"/>,
        <include refid="ru.flexpay.eirc.service_provider_account.service.ServiceProviderAccountBean.generalWithAddressSPAColumns"/>
        from <include refid="tableName"/> as fa

        left join `service_provider_account` spa on spa.`id` = fa.`service_provider_account_id`
        <include refid="ru.flexpay.eirc.service_provider_account.service.ServiceProviderAccountBean.generalWithAddressSPAJoin"/>

        where fa.`id` = #{id}
    </sql>

    <sql id="insertFinancialAttribute">
        insert into <include refid="tableName"/> (`service_provider_account_id`, `amount`, `date_formation`)
                            values (#{serviceProviderAccount.id}, #{amount}, #{dateFormation})
    </sql>

    <sql id="updateFinancialAttribute">
        update <include refid="tableName"/> set `service_provider_account_id` = #{serviceProviderAccount.id},
            `amount` = #{amount}, `date_formation` = #{dateFormation} where `id` = #{id}
    </sql>

</mapper>
