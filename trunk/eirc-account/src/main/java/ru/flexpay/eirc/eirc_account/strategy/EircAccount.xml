<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ru.flexpay.eirc.eirc_account.strategy.EircAccount">

    <resultMap id="EircAccount" type="ru.flexpay.eirc.eirc_account.entity.EircAccount">
        <id column="pk_id" property="pkId"/>
        <result column="object_id" property="id"/>
        <result column="account_number" property="accountNumber"/>
        <result column="begin_date" property="beginDate"/>
        <result column="end_date" property="endDate"/>

        <association property="address" resultMap="Address"/>

        <association property="person" resultMap="ru.flexpay.eirc.dictionary.entity.Person.Person" />
    </resultMap>

    <resultMap id="Address" type="ru.flexpay.eirc.dictionary.entity.Address">
        <id column="address_id" property="id"/>
        <result column="address_entity_id" property="entityId"/>
        <result column="city_type" property="cityType"/>
        <result column="city" property="city"/>
        <result column="street_type" property="streetType"/>
        <result column="street" property="street"/>
        <result column="building" property="building"/>
        <result column="apartment" property="apartment"/>
        <result column="room" property="room"/>
    </resultMap>

    <sql id="apartmentCultureJoin">
        inner join `apartment_attribute` aa on aa.`object_id` = a.`object_id`
        inner join `apartment_string_culture` ac on ac.`id` = aa.`value_id`
    </sql>

    <sql id="buildingAddressCultureJoin">
        inner join `building_address` ba on ba.`object_id` = b.`parent_id`
        inner join `building_address_attribute` baa on baa.`object_id` = b.`parent_id`
        inner join `building_address_string_culture` bac on bac.`id` = baa.`value_id`
    </sql>

    <sql id="streetCultureJoin">
        inner join `street` s on s.`object_id` = ba.`parent_id`
        inner join `street_attribute` sa on sa.`object_id` = ba.`parent_id`
        inner join `street_string_culture` sc on sc.`id` = sa.`value_id`
    </sql>

    <sql id="streetTypeCultureJoin">
        inner join `street_type` st on st.`object_id` = s.`parent_id`
        inner join `street_type_attribute` sta on sta.`object_id` = s.`parent_id`
        inner join `street_type_string_culture` stc on stc.`id` = sta.`value_id`
    </sql>

    <sql id="addressCultureJoin">
        <include refid="buildingAddressCultureJoin"/>
        <include refid="streetCultureJoin"/>
        <include refid="streetTypeCultureJoin"/>
    </sql>

    <select id="selectAddress" resultMap="Address" parameterType="map">
        select #{id} as `id`, #{entityId}  as `entity_id`, stc.`value` as `street_type`, sc.`value` as `street`, bac.`value` as `building`
         <choose>
             <when test="entityId == 500">
                 , null as `apartment`, null as `room`
                 from `building` b
                 <include refid="addressCultureJoin"/>
                 where b.`object_id` = #{id} and
             </when>
             <when test="entityId == 100">
                 , ac.`value` as `apartment`, null as `room`
                 from `apartment` a
                 <include refid="apartmentCultureJoin"/>
                 inner join `building` b on b.`object_id` = a.`parent_id`
                 <include refid="addressCultureJoin"/>
                 where a.`object_id` = #{id} and aa.`end_date` is null and
             </when>
             <when test="entityId == 200">
                 , ac.`value` as `apartment`, rc.`value` as `room`
                 from `room` r
                 inner join `room_attribute` ra on r.`object_id` = ra.`object_id`
                 inner join `room_string_culture` rc on rc.`id` = ra.`value_id`
                 left inner join `apartment` a on a.`object_id` = r.`parent_id` and r.`parent_entity_id` = 100
                 <include refid="apartmentCultureJoin"/>
                 inner join `building` b on (b.`object_id` = r.`parent_id` and r.`parent_entity_id` = 500 or b.`object_id` = a.`parent_id`)
                 <include refid="addressCultureJoin"/>
                 where r.`object_id` = #{id} and ra.`end_date` is null and aa.`end_date` is null and
             </when>
         </choose>baa.`end_date` is null and
                  sa.`end_date`  is null and sa.`attribute_type_id` = 300 and
                  sta.`end_date` is null and sta.`attribute_type_id` = 1400
    </select>

    <sql id="roomJoin">
        left join `room` room on room.`object_id` = e.`address_id` and e.`address_entity_id` = 200
    </sql>

    <sql id="roomCondition">
        room.`object_id` = #{object.address.id}
    </sql>

    <sql id="apartmentJoin">
        <include refid="roomJoin"/>

        left join `apartment` apartment1 on apartment1.`object_id` = room.`parent_id` and room.`parent_entity_id` = 100
        left join `apartment` apartment2 on apartment2.`object_id` = e.`address_id` and e.`address_entity_id` = 100
    </sql>

    <sql id="apartmentCondition">
        (apartment1.`object_id` = #{object.address.id} or apartment2.`object_id` = #{object.address.id})
    </sql>

    <sql id="buildingJoin">
        <include refid="apartmentJoin"/>

        left join `building` building1 on building1.`object_id` = apartment1.`parent_id`
        left join `building` building2 on building2.`object_id` = apartment2.`parent_id`
        left join `building` building3 on building3.`object_id` = room.`parent_id` and room.`parent_entity_id` = 500
        left join `building` building4 on building4.`object_id` = e.`address_id` and e.`address_entity_id` = 500
    </sql>

    <sql id="buildingCondition">
         (building1.`object_id` = #{object.address.id} or building2.`object_id` = #{object.address.id} or
          building3.`object_id` = #{object.address.id} or building4.`object_id` = #{object.address.id})
    </sql>

    <sql id="buildingAddressJoin">
        <include refid="buildingJoin"/>

        left join `building_address` building_a1 on building_a1.`object_id` = building1.`parent_id`
        left join `building_address` building_a2 on building_a2.`object_id` = building2.`parent_id`
        left join `building_address` building_a3 on building_a3.`object_id` = building3.`parent_id`
        left join `building_address` building_a4 on building_a4.`object_id` = building4.`parent_id`
    </sql>

    <sql id="buildingAddressCondition">
        (building_a1.`object_id` = #{object.address.id} or building_a2.`object_id` = #{object.address.id} or
         building_a3.`object_id` = #{object.address.id} or building_a4.`object_id` = #{object.address.id})
    </sql>

    <sql id="streetJoin">
        <include refid="buildingAddressJoin"/>

        left join `street` street1 on street1.`object_id` = building_a1.`parent_id`
        left join `street` street2 on street2.`object_id` = building_a2.`parent_id`
        left join `street` street3 on street3.`object_id` = building_a3.`parent_id`
        left join `street` street4 on street4.`object_id` = building_a4.`parent_id`
    </sql>

    <sql id="streetCondition">
        (street1.`object_id` = #{object.address.id} or street2.`object_id` = #{object.address.id} or street3.`object_id` = #{object.address.id} or street4.`object_id` = #{object.address.id})
    </sql>

    <sql id="cityJoin">
        <include refid="streetJoin"/>

        left join `city` city1 on city1.`object_id` = street1.`parent_id`
        left join `city` city2 on city2.`object_id` = street2.`parent_id`
        left join `city` city3 on city3.`object_id` = street3.`parent_id`
        left join `city` city4 on city4.`object_id` = street4.`parent_id`
    </sql>

    <sql id="cityCondition">
        (city1.`object_id` = #{object.address.id} or city2.`object_id` = #{object.address.id} or city3.`object_id` = #{object.address.id} or city4.`object_id` = #{object.address.id})
    </sql>

    <sql id="regionJoin">
        <include refid="cityJoin"/>

        left join `region` region1 on region1.`object_id` = city1.`parent_id`
        left join `region` region2 on region2.`object_id` = city2.`parent_id`
        left join `region` region3 on region3.`object_id` = city3.`parent_id`
        left join `region` region4 on region4.`object_id` = city4.`parent_id`
    </sql>

    <sql id="regionCondition">
        (region1.`object_id` = #{object.address.id} or region2.`object_id` = #{object.address.id} or region3.`object_id` = #{object.address.id} or region4.`object_id` = #{object.address.id})
    </sql>

    <sql id="countryJoin">
        <include refid="regionJoin"/>

        left join `country` country1 on country1.`object_id` = region1.`parent_id`
        left join `country` country2 on country2.`object_id` = region2.`parent_id`
        left join `country` country3 on country3.`object_id` = region3.`parent_id`
        left join `country` country4 on country4.`object_id` = region4.`parent_id`
    </sql>

    <sql id="countryCondition">
        (country1.`object_id` = #{object.address.id} or country2.`object_id` = #{object.address.id} or country3.`object_id` = #{object.address.id} or country4.`object_id` = #{object.address.id})
    </sql>

    <sql id="addressJoin">
        <choose>
            <when test="map.address == true">
                <include refid="countryJoin"/>
                <include refid="addressJoinCulture"/>
            </when>
            <when test="object.address != null and object.address.entity != null">
                <choose>
                    <when test="object.address.entity.id == 200">
                        <include refid="roomJoin"/>
                    </when>
                    <when test="object.address.entity.id == 100">
                        <include refid="apartmentJoin"/>
                    </when>
                    <when test="object.address.entity.id == 500">
                        <include refid="buildingJoin"/>
                    </when>
                    <when test="object.address.entity.id == 400">
                        <include refid="cityJoin"/>
                    </when>
                    <when test="object.address.entity.id == 800">
                        <include refid="countryJoin"/>
                    </when>
                </choose>
            </when>
        </choose>
    </sql>

    <sql id="addressCondition">
        <if test="object.address != null and object.address.entity != null">
            and
            <choose>
                <when test="object.address.entity.id == 200">
                    <include refid="roomCondition"/>
                </when>
                <when test="object.address.entity.id == 100">
                    <include refid="apartmentCondition"/>
                </when>
                <when test="object.address.entity.id == 500">
                    <include refid="buildingCondition"/>
                </when>
                <when test="object.address.entity.id == 300">
                    <include refid="streetCondition"/>
                </when>
                <when test="object.address.entity.id == 400">
                    <include refid="cityCondition"/>
                </when>
                <when test="object.address.entity.id == 800">
                    <include refid="countryCondition"/>
                </when>
            </choose>
        </if>
        <if test="map.address == true">
            and ra.`end_date`  is null and aa.`end_date`  is null and baa.`end_date` is null and sa1.`end_date` is null
            and sa2.`end_date` is null and sta.`end_date` is null and ca1.`end_date` is null and ca2.`end_date` is null
            and cta.`end_date` is null
        </if>
    </sql>

    <sql id="addressJoinCulture">
        left join `room_attribute` ra on
            (ra.`object_id` = room.`object_id`)
        left join `room_string_culture` rc on (rc.`id` = ra.`value_id` and rc.`locale_id`  = #{locale.id})

        left join `apartment_attribute` aa on
            (aa.`object_id` = apartment1.`object_id` or aa.`object_id` = apartment2.`object_id`)
        left join `apartment_string_culture` ac on ac.`id` = aa.`value_id`

        left join `building_address_attribute` baa on
            (baa.`object_id` = building_a1.`object_id` or baa.`object_id` = building_a2.`object_id` or
             baa.`object_id` = building_a3.`object_id` or baa.`object_id` = building_a4.`object_id`)
        left join `building_address_string_culture` bac on (bac.`id` = baa.`value_id` and bac.`locale_id`  = #{locale.id})

        left join `street_attribute` sa1 on
            ((sa1.`object_id` = street1.`object_id` or sa1.`object_id` = street2.`object_id` or
              sa1.`object_id` = street3.`object_id` or sa1.`object_id` = street4.`object_id`) and sa1.`value_type_id` = 300)
        left join `street_string_culture` sc on (sc.`id` = sa1.`value_id` and sc.`locale_id`  = #{locale.id})

        left join `street_attribute` sa2 on
            ((sa2.`object_id` = street1.`object_id` or sa2.`object_id` = street2.`object_id` or
             sa2.`object_id` = street3.`object_id` or sa2.`object_id` = street4.`object_id`) and sa2.`value_type_id` = 301)
        left join `street_type` st on st.`object_id` = sa2.`value_id`
        left join `street_type_attribute` sta on (sta.`object_id` = st.`object_id` and sta.`value_type_id` = 1400)
        left join `street_type_string_culture` stc on (stc.`id` = sta.`value_id` and stc.`locale_id`  = #{locale.id})

        left join `city_attribute` ca1 on
            ((ca1.`object_id` = city1.`object_id` or ca1.`object_id` = city2.`object_id` or
             ca1.`object_id` = city3.`object_id` or ca1.`object_id` = city4.`object_id`) and ca1.`value_type_id` = 400)
        left join `city_string_culture` cc on (cc.`id` = ca1.`value_id` and cc.`locale_id`  = #{locale.id})

        left join `city_attribute` ca2 on
            ((ca2.`object_id` = city1.`object_id` or ca2.`object_id` = city2.`object_id` or
             ca2.`object_id` = city3.`object_id` or ca2.`object_id` = city4.`object_id`) and ca2.`value_type_id` = 401)
        left join `city_type` ct on ct.`object_id` = ca2.`value_id`
        left join `city_type_attribute` cta on (cta.`object_id` = ct.`object_id` and cta.`value_type_id` = 1300)
        left join `city_type_string_culture` ctc on (ctc.`id` = cta.`value_id` and ctc.`locale_id`  = #{locale.id})
    </sql>

    <sql id="addressFields">
        <if test="map.address == true">
            , ctc.`value` as `city_type`, cc.`value` as `city`, stc.`value` as `street_type`, sc.`value` as `street`
            , bac.`value` as `building`, ac.`value` as `apartment`, rc.`value` as `room`
        </if>
    </sql>

    <select id="selectEircAccounts" parameterType="org.complitex.dictionary.entity.FilterWrapper" resultMap="EircAccount">
        select e.*
        <include refid="addressFields"/>
        from `eirc_account` e
        <include refid="addressJoin"/>
        where e.`end_date` is null
        <include refid="addressCondition"/>

        <if test="object.accountNumber != null">
            and e.`account_number` like concat('%', #{object.accountNumber}, '%')
        </if>

        <if test="object.person != null">
            <if test="object.person.lastName != null">
                and e.`last_name` like concat('%', #{object.person.lastName}, '%')
            </if>
            <if test="object.person.firstName != null">
                and e.`first_name` like concat('%', #{object.person.firstName}, '%')
            </if>
            <if test="object.person.middleName != null">
                and e.`middle_name` like concat('%', #{object.person.middleName}, '%')
            </if>
        </if>

        <if test="sortProperty != null">
            order by
            <choose>
                <when test="sortProperty == 'person'">
                    e.`last_name`
                    <if test="asc">
                        ${asc}
                    </if>,
                    e.`first_name`
                    <if test="asc">
                        ${asc}
                    </if>,
                    e.`middle_name`
                </when>
                <when test="sortProperty == 'address'">
                    `city_type`
                    <if test="asc">
                        ${asc}
                    </if>,
                    `city`
                    <if test="asc">
                        ${asc}
                    </if>,
                    `street_type`
                    <if test="asc">
                        ${asc}
                    </if>,
                    `street`
                    <if test="asc">
                        ${asc}
                    </if>,
                    `building`
                    <if test="asc">
                        ${asc}
                    </if>,
                    `apartment`
                    <if test="asc">
                        ${asc}
                    </if>,
                    `room`
                    <if test="asc">
                        ${asc}
                    </if>,
                    e.`middle_name`
                </when>
                <otherwise>
                    ${sortProperty}
                </otherwise>
            </choose>
            <if test="asc">
                ${asc}
            </if>
        </if>
        <if test="count > 0">
            limit ${first},${count}
        </if>
    </select>

    <select id="countEircAccounts" parameterType="org.complitex.dictionary.entity.FilterWrapper" resultType="integer">
        select count(distinct e.`object_id`) from `eirc_account` e
        <include refid="addressJoin"/>
        where e.`end_date` is null
        <include refid="addressCondition"/>
    </select>

    <select id="selectEircAccount" parameterType="long" resultMap="EircAccount">
        select * from `eirc_account` where `object_id` = #{id} order by `begin_date` desc
    </select>

    <select id="selectEircAccountByPkId" parameterType="long" resultMap="EircAccount">
        select * from `eirc_account` where `pk_id` = #{pkId}
    </select>

    <select id="selectEircAccountsByPkId" parameterType="map" resultMap="EircAccount">
        select * from `eirc_account` where `pk_id` in #{pkIds}
    </select>

    <insert id="insert" parameterType="ru.flexpay.eirc.eirc_account.entity.EircAccount" keyProperty="pkId" useGeneratedKeys="true">
        insert into `eirc_account` (`object_id`, `account_number`, `address_id`, `address_entity_id`,
                                    `first_name`, `last_name`, `middle_name`, `begin_date`, `end_date`)
                            values (#{id}, #{accountNumber}, #{address.id}, #{address.entity.id},
                                    #{person.firstName}, #{person.lastName}, #{person.middleName}, #{beginDate}, #{endDate})
    </insert>

    <update id="updateEndDate" parameterType="ru.flexpay.eirc.eirc_account.entity.EircAccount">
        update `eirc_account` set `end_date` = #{endDate} where `pk_id` = #{id}
    </update>

</mapper>
