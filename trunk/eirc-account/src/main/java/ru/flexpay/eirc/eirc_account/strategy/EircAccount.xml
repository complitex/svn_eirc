<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ru.flexpay.eirc.eirc_account.entity.EircAccount">

    <resultMap id="EircAccount" type="ru.flexpay.eirc.eirc_account.entity.EircAccount">
        <id column="pk_id" property="pkId"/>
        <result column="object_id" property="objectId"/>
        <result column="account_number" property="accountNumber"/>
        <result column="begin_date" property="beginDate"/>
        <result column="end_date" property="endDate"/>

        <association property="address" select="getAddress"/>

        <association property="person" resultMap="ru.flexpay.eirc.dictionary.entity.Person.Person" />
    </resultMap>

    <resultMap id="Address" type="ru.flexpay.eirc.dictionary.entity.Address"
               extends="org.complitex.dictionary.entity.DomainObject"/>
    
    <select id="getAddress" resultMap="address" parameterType="map">
        select e.*
        from
         <choose>
             <when test="address_entity_id == 500">
                 `building`
             </when>
             <when test="address_entity_id == 200">
                 `apartment`
             </when>
             <when test="address_entity_id == 100">
                 `room`
             </when>
         </choose> e where e.`object_id` = #{address_id}
    </select>

    <sql id="selectByApartmentJoin">
        left join `room` room on room.`object_id` = e.`object_id` and e.`address_entity_id` = 200
        left join `apartment` apartment1 on apartment1.`object_id` = room.`parent_id` and room.`parent_entity_id` = 100
        left join `apartment` apartment2 on apartment1.`object_id` = e.`object_id` and apartment2.`address_entity_id` = 100
    </sql>
    
    <sql id="selectByApartmentWhere">
        <include refid="selectByApartmentJoin"/>
        where apartment1.`object_id` = #{object.id} or apartment2.`object_id` = #{object.id}
    </sql>

    <sql id="selectByBuildingJoin">
        <include refid="selectByApartmentJoin"/>

        left join `building` building1 on building1.`object_id` = apartment1.`parent_id`
        left join `building` building2 on building2.`object_id` = apartment2.`parent_id`
        left join `building` building3 on building3.`object_id` = room1.`parent_id` and room1.`parent_entity_id` = 500
        left join `building` building4 on building4.`object_id` = e.`address_id` and e.`address_entity_id` = 500
    </sql>

    <sql id="selectByBuildingWhere">
        <include refid="selectByBuildingJoin"/>

        where building1.`object_id` = #{object.id} or building2.`object_id` = #{object.id} or 
              building3.`object_id` = #{object.id} or building4.`object_id` = #{object.id}
    </sql>

    <sql id="selectByBuildingAddressJoin">
        <include refid="selectByBuildingJoin"/>

        left join `building_address` building_a1 on building_a1.`object_id` = building1.`parent_id`
        left join `building_address` building_a2 on building_a2.`object_id` = building2.`parent_id`
        left join `building_address` building_a3 on building_a3.`object_id` = building3.`parent_id`
        left join `building_address` building_a4 on building_a4.`object_id` = building4.`parent_id`
    </sql>
    
    <sql id="selectByBuildingAddressSql">
        <include refid="selectByBuildingAddressJoin"/>

        where building_a1.`object_id` = #{object.id} or building_a2.`object_id` = #{object.id} or 
              building_a3.`object_id` = #{object.id} or building_a4.`object_id` = #{object.id}
    </sql>

    <sql id="selectByStreetJoin">
        <include refid="selectByBuildingAddressJoin"/>
        
        left join `street` street1 on street1.`object_id` = building_a1.`parent_id`
        left join `street` street2 on street2.`object_id` = building_a2.`parent_id`
        left join `street` street3 on street3.`object_id` = building_a3.`parent_id`
        left join `street` street4 on street4.`object_id` = building_a4.`parent_id`
    </sql>
    
    <sql id="selectByStreetWhere">
        <include refid="selectByStreetJoin"/>

        where street1.`object_id` = #{object.id} or street2.`object_id` = #{object.id} or street3.`object_id` = #{object.id} or street4.`object_id` = #{object.id}
    </sql>

    <sql id="selectByCityJoin">

        <include refid="selectByStreetJoin"/>
        
        left join `city` city1 on city1.`object_id` = street1.`parent_id`
        left join `city` city2 on city2.`object_id` = street2.`parent_id`
        left join `city` city3 on city3.`object_id` = street3.`parent_id`
        left join `city` city4 on city4.`object_id` = street4.`parent_id`
    </sql>

    <sql id="selectByCityWhere">
        <include refid="selectByCityJoin"/>

        where city1.`object_id` = #{object.id} or city2.`object_id` = #{object.id} or city3.`object_id` = #{object.id} or city4.`object_id` = #{object.id}
    </sql>

    <sql id="selectByRegionJoin">
        <include refid="selectByCityJoin"/>

        left join `region` region1 on region1.`object_id` = city1.`parent_id`
        left join `region` region2 on region2.`object_id` = city2.`parent_id`
        left join `region` region3 on region3.`object_id` = city3.`parent_id`
        left join `region` region4 on region4.`object_id` = city4.`parent_id`
    </sql>
    
    <sql id="selectByRegionSelect">
        <include refid="selectByRegionJoin"/>

        where region1.`object_id` = #{object.id} or region2.`object_id` = #{object.id} or region3.`object_id` = #{object.id} or region4.`object_id` = #{object.id}
    </sql>

    <sql id="selectByCountryJoin">
        <include refid="selectByRegionJoin"/>
        
        left join `country` country1 on country1.`object_id` = region1.`parent_id`
        left join `country` country2 on country2.`object_id` = region2.`parent_id`
        left join `country` country3 on country3.`object_id` = region3.`parent_id`
        left join `country` country4 on country4.`object_id` = region4.`parent_id`
    </sql>

    <sql id="selectByCountryWhere">
        <include refid="selectByCountryJoin"/>

        where country1.`object_id` = #{object.id} or country2.`object_id` = #{object.id} or country3.`object_id` = #{object.id} or country4.`object_id` = #{object.id}
    </sql>

    <sql id="selectByAddressWhere">
        <choose>
            <when test="object.entity.id == 200">
                <include refid="selectByRoomWhere"/>
            </when>
            <when test="object.entity.id == 100">
                <include refid="selectByApartmentWhere"/>
            </when>
            <when test="object.entity.id == 500">
                <include refid="selectByBuildingWhere"/>
            </when>
            <when test="object.entity.id == 300">
                <include refid="selectByStreetWhere"/>
            </when>
            <when test="object.entity.id == 400">
                <include refid="selectByCityWhere"/>
            </when>
            <when test="object.entity.id == 800">
                <include refid="selectByCountryWhere"/>
            </when>
        </choose>
    </sql>

    <select id="selectEircAccounts" parameterType="org.complitex.dictionary.entity.FilterWrapper" resultType="long">
        select distinct e.`object_id` from `eirc_account` e
        <include refid="selectByAddressWhere"/>

        <if test="sortProperty != null">
            order by ${sortProperty}
            <if test="asc">
                ${asc}
            </if>
        </if>
        <if test="count > 0">
            limit ${first},${count}
        </if>
    </select>

    <select id="countEircAccount" parameterType="org.complitex.dictionary.entity.FilterWrapper" resultType="integer">
        select count(distinct e.`object_id`) from `eirc_account` e
        <include refid="selectByAddressWhere"/>
    </select>

</mapper>
